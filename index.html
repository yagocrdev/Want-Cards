<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Want Cards - MTG</title>

    <!-- ForÃ§a atualizaÃ§Ã£o rÃ¡pida (anti-cache) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: black;
            color: white;
            display: flex;
            justify-content: center;
        }
        .main {
            width: 100%;
            max-width: 1200px;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background: url("https://cards.scryfall.io/back.png") no-repeat center center;
            background-size: 600px auto; /* Aumentado para ficar mais visÃ­vel */
            background-attachment: fixed; /* Opcional: faz o fundo ficar "fixo" ao scrollar */
        }
        h1, h2 { text-align: center; }
        .search-container {
            position: relative;
            max-width: 400px;
            margin: 20px auto;
            display: none;
        }
        input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
        }
        .suggestions {
            position: absolute;
            width: 100%;
            background: #1e1e1e;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 5px;
            z-index: 10;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            gap: 10px;
        }
        .suggestion-item:hover { background: #333; }
        .suggestion-item img {
            width: 40px;
            height: auto;
            border-radius: 5px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            transition: 0.2s;
        }
        .card.procurando { border: 2px solid #00ff88; }
        .card img {
            width: 100%;
            max-width: 180px;
            height: auto;
            border-radius: 10px;
        }
        .price { color: #00ff88; font-weight: bold; margin: 5px 0; }
        button {
            margin: 4px;
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-procurando { background: #444; color: white; }
        .btn-remover { background: #aa0000; color: white; }
        .admin-info { text-align: center; font-size: 12px; color: #777; margin-top: 15px; }
    </style>
</head>
<body>
<div class="main">
    <h1>ðŸ§™ Want Cards - MTG</h1>
    <div id="searchArea" class="search-container">
        <input type="text" id="busca" placeholder="Digite o nome da carta..." oninput="buscarSugestoes()">
        <div id="sugestoes" class="suggestions"></div>
    </div>
    <h2>Cartas Procuradas</h2>
    <div id="lista" class="grid"></div>
    <div class="admin-info">
        Pressione Ctrl + Shift + A para modo administrador
    </div>
</div>

<script>
    const ADMIN_PASSWORD = "mtg123";
    const COTACAO_DOLAR = 5.00;

    let isAdmin = sessionStorage.getItem("adminMTG") === "true";
    let listaCartas = JSON.parse(localStorage.getItem("cartasMTG")) || [];

    if (isAdmin) {
        document.getElementById("searchArea").style.display = "block";
    }

    document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === "A") {
            const senha = prompt("Digite a senha de administrador:");
            if (senha === ADMIN_PASSWORD) {
                sessionStorage.setItem("adminMTG", "true");
                location.reload();
            } else {
                alert("Senha incorreta!");
            }
        }
    });

    window.onload = () => renderizarLista();

    async function buscarSugestoes() {
        if (!isAdmin) return;

        const nome = document.getElementById("busca").value.trim();
        if (nome.length < 2) {
            document.getElementById("sugestoes").innerHTML = "";
            return;
        }

        try {
            const resp = await fetch(`https://api.scryfall.com/cards/autocomplete?q=${encodeURIComponent(nome)}`);
            const data = await resp.json();

            const sugestoesDiv = document.getElementById("sugestoes");
            sugestoesDiv.innerHTML = "";

            for (let nomeCarta of data.data.slice(0, 6)) {
                try {
                    const cartaResp = await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(nomeCarta)}`);
                    const carta = await cartaResp.json();

                    let img = carta.image_uris?.small;
                    if (carta.card_faces?.[0]?.image_uris?.small) {
                        img = carta.card_faces[0].image_uris.small;
                    }

                    const div = document.createElement("div");
                    div.classList.add("suggestion-item");
                    div.innerHTML = `<img src="${img || 'https://via.placeholder.com/40?text=?'}"><span>${nomeCarta}</span>`;
                    div.addEventListener("click", () => {
                        adicionarCartaPorNome(nomeCarta);
                        sugestoesDiv.innerHTML = "";
                        document.getElementById("busca").value = "";
                    });
                    sugestoesDiv.appendChild(div);
                } catch (err) {
                    console.warn(`Falha ao carregar miniatura de ${nomeCarta}`, err);
                }
            }
        } catch (err) {
            console.error("Erro na busca de sugestÃµes:", err);
        }
    }

    async function adicionarCartaPorNome(nomeCarta) {
        try {
            const query = `!"${nomeCarta}"`;
            const resp = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&order=usd`);
            if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);

            const data = await resp.json();
            if (!data.data?.length) {
                alert(`Carta "${nomeCarta}" nÃ£o encontrada na Scryfall.`);
                return;
            }

            let menorPrecoUSD = Infinity;
            let imagemEscolhida = null;

            for (const carta of data.data) {
                const precos = [
                    parseFloat(carta.prices?.usd),
                    parseFloat(carta.prices?.usd_foil),
                    parseFloat(carta.prices?.usd_etched)
                ].filter(v => !isNaN(v) && v > 0);

                if (precos.length > 0) {
                    menorPrecoUSD = Math.min(menorPrecoUSD, Math.min(...precos));
                }

                let img = carta.image_uris?.normal || carta.image_uris?.large;
                if (carta.card_faces?.[0]?.image_uris) {
                    img = carta.card_faces[0].image_uris.normal || carta.card_faces[0].image_uris.large;
                }

                if (img && !imagemEscolhida) {
                    imagemEscolhida = img;
                }
            }

            if (menorPrecoUSD === Infinity) menorPrecoUSD = 0;
            if (!imagemEscolhida) {
                alert(`Nenhuma imagem disponÃ­vel para "${nomeCarta}".`);
                return;
            }

            const precoBRL = (menorPrecoUSD * COTACAO_DOLAR).toFixed(2);

            let cartaExistente = listaCartas.find(c => c.nome === nomeCarta);
            if (cartaExistente) {
                cartaExistente.quantidade += 1;
                cartaExistente.preco = precoBRL;
                cartaExistente.imagem = imagemEscolhida;
            } else {
                listaCartas.push({
                    id: Date.now(),
                    nome: nomeCarta,
                    imagem: imagemEscolhida,
                    preco: precoBRL,
                    quantidade: 1,
                    procurando: true
                });
            }

            salvar();
            renderizarLista();
        } catch (err) {
            console.error("Erro ao adicionar carta:", err);
            alert("Erro ao buscar a carta. Abra o console (F12) para detalhes.");
        }
    }

    function toggleProcurando(id) {
        listaCartas = listaCartas.map(c => c.id === id ? { ...c, procurando: !c.procurando } : c);
        salvar();
        renderizarLista();
    }

    function removerCarta(id) {
        listaCartas = listaCartas.filter(c => c.id !== id);
        salvar();
        renderizarLista();
    }

    function salvar() {
        localStorage.setItem("cartasMTG", JSON.stringify(listaCartas));
    }

    function renderizarLista() {
        const lista = document.getElementById("lista");
        lista.innerHTML = "";

        const cartasExibidas = isAdmin ? listaCartas : listaCartas.filter(c => c.procurando);

        cartasExibidas.forEach(carta => {
            const div = document.createElement("div");
            div.classList.add("card");
            if (carta.procurando) div.classList.add("procurando");

            div.innerHTML = `
                <img src="${carta.imagem}" alt="${carta.nome}">
                <p>${carta.nome}</p>
                <div class="price">R$ ${carta.preco}</div>
                <p>Qtd: ${carta.quantidade}</p>
                ${isAdmin ? `
                    <button class="btn-procurando" onclick="toggleProcurando(${carta.id})">
                        ${carta.procurando ? "âœ” Procurando" : "Marcar Procurando"}
                    </button>
                    <button class="btn-remover" onclick="removerCarta(${carta.id})">Remover</button>
                ` : ""}
            `;
            lista.appendChild(div);
        });
    }
</script>
<!-- ForÃ§ar rebuild final - 2026 -->
</body>
</html>
