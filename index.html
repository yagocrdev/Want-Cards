<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Want Cards - MTG</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: black;
            color: white;
            display: flex;
            justify-content: center;
        }
        .main {
            width: 100%;
            max-width: 1200px;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background: url("https://cards.scryfall.io/back.png") no-repeat center center fixed;
            background-size: 700px auto; /* Ajuste se quiser maior: 800px ou 60vw */
            background-position: center center;
        }
        h1, h2 { text-align: center; }
        .search-container {
            position: relative;
            max-width: 400px;
            margin: 20px auto;
            display: none;
        }
        input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
        }
        .suggestions {
            position: absolute;
            width: 100%;
            background: #1e1e1e;
            border-radius: 8px;
            max-height: 280px;
            overflow-y: auto;
            margin-top: 5px;
            z-index: 10;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            gap: 10px;
        }
        .suggestion-item:hover { background: #333; }
        .suggestion-item img {
            width: 40px;
            height: auto;
            border-radius: 5px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            transition: 0.2s;
        }
        .card.procurando { border: 2px solid #00ff88; }
        .card img {
            width: 100%;
            max-width: 180px;
            height: auto;
            border-radius: 10px;
        }
        .price { color: #00ff88; font-weight: bold; margin: 5px 0; }
        button {
            margin: 4px;
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-procurando { background: #444; color: white; }
        .btn-remover { background: #aa0000; color: white; }
        .admin-info { text-align: center; font-size: 12px; color: #777; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="main">
        <h1>ðŸ§™ Want Cards - MTG</h1>
        <div id="searchArea" class="search-container">
            <input type="text" id="busca" placeholder="Digite o nome da carta (PT ou EN)..." oninput="buscarSugestoes()">
            <div id="sugestoes" class="suggestions"></div>
        </div>
        <h2>Cartas Procuradas</h2>
        <div id="lista" class="grid"></div>
        <div class="admin-info">
            Pressione Ctrl + Shift + A para modo administrador
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "8090200";
        let isAdmin = sessionStorage.getItem("adminMTG") === "true";
        let listaCartas = JSON.parse(localStorage.getItem("cartasMTG")) || [];

        if (isAdmin) {
            document.getElementById("searchArea").style.display = "block";
        }

        document.addEventListener("keydown", function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === "A") {
                const senha = prompt("Digite a senha de administrador:");
                if (senha === ADMIN_PASSWORD) {
                    sessionStorage.setItem("adminMTG", "true");
                    location.reload();
                } else {
                    alert("Senha incorreta!");
                }
            }
        });

        window.onload = () => renderizarLista();

        // BUSCA COM SUGESTÃ•ES - SUPORTE MELHORADO PARA PT/EN
        async function buscarSugestoes() {
            if (!isAdmin) return;
            const termo = document.getElementById("busca").value.trim();
            if (termo.length < 3) {
                document.getElementById("sugestoes").innerHTML = "";
                return;
            }

            try {
                // Query otimizada: busca fuzzy em printed_name (PT) ou name (EN)
                const query = `(printed_name:${encodeURIComponent(termo)} lang:pt) OR name:${encodeURIComponent(termo)} include:multilingual`;
                const url = `https://api.scryfall.com/cards/search?q=${query}&order=usd&unique=prints&include_multilingual=true`;
                
                const resp = await fetch(url);
                if (!resp.ok) {
                    if (resp.status === 404) {
                        document.getElementById("sugestoes").innerHTML = '<div style="padding:10px;color:#888;">Nenhuma carta encontrada</div>';
                        return;
                    }
                    throw new Error("Erro na API Scryfall: " + resp.status);
                }
                
                const data = await resp.json();
                const sugestoesDiv = document.getElementById("sugestoes");
                sugestoesDiv.innerHTML = "";

                const cartas = data.data?.slice(0, 8) || [];

                for (const carta of cartas) {
                    // Nome exibido: prioriza PT
                    let nomeExibido = (carta.printed_name && carta.lang === "pt") ? carta.printed_name : carta.name;
                    
                    // Imagem small (face frontal)
                    let img = carta.image_uris?.small;
                    if (carta.card_faces?.[0]?.image_uris?.small) {
                        img = carta.card_faces[0].image_uris.small;
                    }

                    const div = document.createElement("div");
                    div.classList.add("suggestion-item");
                    div.innerHTML = `
                        <img src="${img || 'https://cards.scryfall.io/small/front/0/0/00000000-0000-0000-0000-000000000000.jpg'}">
                        <span>${nomeExibido}</span>
                        <small style="color:#888;">(${carta.lang.toUpperCase()})</small>
                    `;
                    div.addEventListener("click", () => {
                        adicionarCarta(carta);
                        sugestoesDiv.innerHTML = "";
                        document.getElementById("busca").value = "";
                    });
                    sugestoesDiv.appendChild(div);
                }

                if (cartas.length === 0) {
                    sugestoesDiv.innerHTML = '<div style="padding:10px;color:#888;">Nenhuma carta encontrada. Tente em inglÃªs.</div>';
                }
            } catch (err) {
                console.error("Erro na busca:", err);
                document.getElementById("sugestoes").innerHTML = '<div style="padding:10px;color:#f66;">Erro ao buscar. Tente novamente.</div>';
            }
        }

        // ADICIONAR CARTA - PREÃ‡OS ATUALIZADOS VIA SCRYFALL + COTAÃ‡ÃƒO DÃ“LAR REAL-TIME
        async function adicionarCarta(cartaApi) {
            try {
                // Nome final: prioriza PT
                let nomeFinal = (cartaApi.printed_name && cartaApi.lang === "pt") ? cartaApi.printed_name : cartaApi.name;

                // Pegar menor preÃ§o USD da Scryfall
                let menorPrecoUSD = Infinity;
                const precos = [
                    parseFloat(cartaApi.prices?.usd),
                    parseFloat(cartaApi.prices?.usd_foil),
                    parseFloat(cartaApi.prices?.usd_etched)
                ].filter(v => !isNaN(v) && v > 0);
                if (precos.length > 0) {
                    menorPrecoUSD = Math.min(...precos);
                }

                // Pegar cotaÃ§Ã£o do dÃ³lar real-time (AwesomeAPI)
                let cotacaoDolar = 5.50; // Fallback se API falhar
                try {
                    const cotResp = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
                    if (cotResp.ok) {
                        const cotData = await cotResp.json();
                        cotacaoDolar = parseFloat(cotData.USD.bid); // PreÃ§o de venda
                    }
                } catch (cotErr) {
                    console.warn("Falha ao buscar cotaÃ§Ã£o do dÃ³lar:", cotErr);
                }

                const precoBRL = menorPrecoUSD === Infinity ? "â€”" : (menorPrecoUSD * cotacaoDolar).toFixed(2);

                // Imagem (face frontal, normal ou large)
                let imagem = cartaApi.image_uris?.normal || cartaApi.image_uris?.large;
                if (cartaApi.card_faces?.[0]?.image_uris) {
                    imagem = cartaApi.card_faces[0].image_uris.normal || cartaApi.card_faces[0].image_uris.large;
                }

                if (!imagem) {
                    alert("NÃ£o foi possÃ­vel encontrar imagem para esta carta.");
                    return;
                }

                // Adicionar ou incrementar/atualizar
                let existente = listaCartas.find(c => c.nome === nomeFinal);
                if (existente) {
                    existente.quantidade += 1;
                    existente.preco = precoBRL;
                    existente.imagem = imagem;
                } else {
                    listaCartas.push({
                        id: Date.now(),
                        nome: nomeFinal,
                        imagem: imagem,
                        preco: precoBRL,
                        quantidade: 1,
                        procurando: true
                    });
                }

                salvar();
                renderizarLista();
            } catch (err) {
                console.error("Erro ao adicionar carta:", err);
                alert("Erro ao adicionar carta. Verifique o console (F12).");
            }
        }

        // FUNÃ‡Ã•ES AUXILIARES
        function toggleProcurando(id) {
            listaCartas = listaCartas.map(c => c.id === id ? { ...c, procurando: !c.procurando } : c);
            salvar();
            renderizarLista();
        }

        function removerCarta(id) {
            listaCartas = listaCartas.filter(c => c.id !== id);
            salvar();
            renderizarLista();
        }

        function salvar() {
            localStorage.setItem("cartasMTG", JSON.stringify(listaCartas));
        }

        function renderizarLista() {
            const lista = document.getElementById("lista");
            lista.innerHTML = "";
            const cartasExibidas = isAdmin ? listaCartas : listaCartas.filter(c => c.procurando);

            cartasExibidas.forEach(carta => {
                const div = document.createElement("div");
                div.classList.add("card");
                if (carta.procurando) div.classList.add("procurando");
                div.innerHTML = `
                    <img src="${carta.imagem}" alt="${carta.nome}">
                    <p>${carta.nome}</p>
                    <div class="price">R$ ${carta.preco}</div>
                    <p>Qtd: ${carta.quantidade}</p>
                    ${isAdmin ? `
                        <button class="btn-procurando" onclick="toggleProcurando(${carta.id})">
                            ${carta.procurando ? "âœ” Procurando" : "Marcar como Procurando"}
                        </button>
                        <button class="btn-remover" onclick="removerCarta(${carta.id})">
                            Remover
                        </button>
                    ` : ""}
                `;
                lista.appendChild(div);
            });
        }
    </script>
</body>
</html>